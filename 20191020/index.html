<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <!--bootstrap和jquery-->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous">
    </script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous">
    </script>
    <!--初始化 和自訂css-->
    <style>
        /* Always set the map height explicitly to define the size of the div
        * element that contains the map. */
        #map {
            height: 100%;
        }

        /* Optional: Makes the sample page fill the window. */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <script>
        var map;

        //主方法 會自動執行此方法
        function initMap() {
            map = new google.maps.Map(
                document.getElementById('map'), {
                    center: new google.maps.LatLng(25.039838, 121.554),
                    zoom: 16
                }
            );
            //圖釘的樣式 可以自訂名稱
            var icons = {
                ubike: {
                    icon: 'picture/bike.png'
                },
                blueubike: {
                    icon: 'picture/bike_blue.png'
                }
            };
            //此方法會回傳
            var features = getUbikeLocation();

            //主要的方法 
            for (var i = 0; i < features.length; i++) {
                var marker = new google.maps.Marker({
                    position: features[i].position, //對應features的座標位置
                    icon: icons[features[i].type].icon, //對應的是features和icons
                    map: map,
                    title: features[i].title //對應features的座標位置
                });
            };
        }

        //取得官方資料的方法
        function getOpenData() {
            let ubikelocation;
            $.ajax({
                type: "get",
                url: "https://tcgbusfs.blob.core.windows.net/blobyoubike/YouBikeTP.json",
                success: function (data) {
                    //console.log("data is", data); //確定是否正常抓取資料
                    ubikelocation=data;
                },
                error: function () {
                    console.log("error");
                },
                async:false,//非同步方法關閉 變成同步
            });
            return ubikelocation;
        }

        //取得官方資料後 進行分析後 重新組成一個陣列 
        function getUbikeLocation(){
        /*
            [
            {
                position: new google.maps.LatLng(-33.91721, 151.22630),
                type: 'info'
            },
            {
                position: new google.maps.LatLng(-33.91727341958453, 151.23348314155578),
                type: 'library'
            }
            ]
        */
            var data=[];
            var openData =getOpenData();
            //$.each(資料內容,function(i,item){});
            //方法是反應內容使用 i是序號 item是物件內容
            
            $.each(
                openData.retVal,//retVal屬性 才是真正陣列內容
                function(i,item){
                    var singleItem = {
                        position: new google.maps.LatLng(item.lat, item.lng),
                        type: 'ubike',
                        title: item.sbi+'/'+item.tot,
                    }
                    //10筆以下的改用藍色圖示
                    if(item.sbi<10){
                        singleItem.type='blueubike';
                    }
                    data.push(singleItem);//每次都建立一個新的物件 放到data
                }
            );
            return data;
        }
    </script>

    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBsrruKCly6mpoh1wm1wrMPsMaAgbXY77M&callback=initMap"
        async defer></script>
</body>

</html>